name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint
      
      - name: Run flake8
        run: |
          flake8 src/ scripts/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ scripts/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
      
      - name: Run pylint
        run: |
          pylint src/ scripts/ --exit-zero --rcfile=.pylintrc || true

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Verify source structure
        run: |
          echo "Checking source structure..."
          echo "Current directory: $(pwd)"
          echo "Workspace: ${{ github.workspace }}"
          echo ""
          echo "Git tracked files in src/models:"
          git ls-files src/models/ || echo "No files tracked in src/models/"
          echo ""
          echo "Checking src/ directory:"
          if [ -d "src" ]; then
            echo "✓ src/ exists"
            ls -la src/ || echo "Cannot list src/"
            echo ""
            echo "Checking src/models/:"
            if [ -d "src/models" ]; then
              echo "✓ src/models/ directory exists"
              ls -la src/models/ || echo "Cannot list src/models/"
              if [ ! -f "src/models/load_model.py" ]; then
                echo "✗ WARNING: src/models/load_model.py not found!"
                echo "Files in src/models/:"
                find src/models -type f || echo "No files found"
              fi
            else
              echo "✗ src/models/ directory does not exist!"
              echo "This is a critical error - the directory must exist."
              echo "Please ensure src/models/ files are committed to git."
              exit 1
            fi
            echo ""
            echo "Checking src/data/:"
            if [ -d "src/data" ]; then
              echo "✓ src/data/ directory exists"
              ls -la src/data/ || echo "Cannot list src/data/"
            else
              echo "✗ src/data/ directory does not exist!"
            fi
            echo ""
            echo "All Python files in src/:"
            find src -name "*.py" -type f || echo "No Python files found"
          else
            echo "✗ src/ directory does not exist!"
            exit 1
          fi
      
      - name: Install package in editable mode
        run: |
          pip install -e . || echo "Editable install failed, will use PYTHONPATH"
      
      - name: Verify package installation
        run: |
          python -c "import src; print('✓ src module found')" || echo "✗ src module not found"
          python -c "from src.models.load_model import ModelLoader; print('✓ src.models.load_model found')" || echo "✗ src.models.load_model not found"
          python -c "from src.data.preprocessing import HeartDiseasePreprocessor; print('✓ src.data.preprocessing found')" || echo "✗ src.data.preprocessing not found"
      
      - name: Run unit tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=xml
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
